var SuggestionEngine=function(){this._name="SuggestionEngine";this._loadedTimer;this.counter=0;this.counterMax=8;this._counter=0;this.init()};SuggestionEngine.prototype=Object.create(ControllerModule.prototype);SuggestionEngine.prototype.constructor=SuggestionEngine;SuggestionEngine.prototype.init=function(){console.log("Suggestion Engine Init");ControllerModule.prototype.init.call(this);this._canvas=window.gameObj.getCanvas();this._model=new SuggestionEngineData();this._model.controller=this;this._model.loadData(this.dataLoaded.bind(this));this._view=new SuggestionEngineView();this._view.controller=this};SuggestionEngine.prototype.dataLoaded=function(){if(this._model._loaded){this._view._recoms=this._model._data}else{if(this._model._status==0){this._loadedTimer=setInterval(this.waitForLoadComplete.bind(this),500)}}};SuggestionEngine.prototype.waitForLoadComplete=function(){if(this._counter++>=this.counterMax){clearInterval(this._loadedTimer)}if(this._model._loaded){clearInterval(this._loadTimer);this._view._recoms=this._model._data}};SuggestionEngine.prototype.displayRightScroller=function(){this._view.displayRightScroller()};console.log("SuggestionEngine.js loaded");function SuggestionEngineData(){DataModule.call(this);this._retrievalURL="./data/data.json";this._data="empty data";this.suggestions=[];this.callBack;this._loaded=false;this._name="SuggestionEngineData"}SuggestionEngineData.prototype=Object.create(DataModule.prototype);SuggestionEngineData.prototype.constructor=SuggestionEngineData;SuggestionEngineData.prototype.digestData=function(){console.log("Data returned ! ");console.log(this._data);this.suggestions=this._data.results;this._loaded=true;this._status=1;if(this.callBack!=undefined){this.callBack()}};function SuggestionEngineView(){ViewModule.call(this);this._name="SuggestionEngineView";this._version="1.0.1";this._textPadding=33;this._loaded=false;SuggestionEngineView.PRE_ANIMATION=0;SuggestionEngineView.ANIMATING=1;SuggestionEngineView.POST_ANIMATION=2;SuggestionEngineView.FINISHED_ANIMATION=3;this.imgPadding=6;this.imgMax=3;this._animating=false;this._animationStatus=SuggestionEngineView.PRE_ANIMATION;this._dataLoadedInt=-1;this._imagesLoadedInt=0;console.log("SuggestionEngineView Instantiated ver "+this._version)}SuggestionEngineView.prototype=Object.create(ViewModule.prototype);SuggestionEngineView.prototype.draw=function(){if(this._animationStatus==SuggestionEngineView.PRE_ANIMATION){this._animationStatus=SuggestionEngineView.ANIMATING}if(this._animationStatus==SuggestionEngineView.ANIMATING){this.animating_draw()}else{this.static_draw()}};SuggestionEngineView.prototype.animating_draw=function(){this.screenElements.forEach(function(a){a.draw()}.bind(this))};SuggestionEngineView.prototype.static_draw=function(){this.screenElements.forEach(function(a){a.draw()}.bind(this))};SuggestionEngineView.prototype.shrinkFinished=function(a){console.log("Trying to finish the shrink and call inactive to "+this.controller+"  growing? "+a);if(a){console.log("Canvas grew and now inactive");this.controller.isActive=false}};SuggestionEngineView.prototype.imageHeight=function(){return Math.ceil((HUDCanvas.height-(this.imgPadding*this.imgMax))-4)/this.imgMax},SuggestionEngineView.prototype.imageWidth=function(){return Math.ceil((this.imageHeight()/2)*3)},SuggestionEngineView.prototype.bgHeight=function(){return(HUDCanvas.height-4)},SuggestionEngineView.prototype.bgWidth=function(){return(this.imageWidth()+this.imgPadding*2)},SuggestionEngineView.prototype.setUpRightScrollerProps=function(){console.log("Setting Up Right Scroller Props  "+this.controller._model._loaded);if(!this.controller._model._loaded){console.log("Data is not loaded");if(this._dataLoadedInt==-1){this._dataLoadedInt=setInterval(this.setUpRightScrollerProps.bind(this),200)}return}if(this._dataLoadedInt>0){clearInterval(this._dataLoadedInt)}this._recoms=this.controller._model.suggestions;this._rightScrollerPropsSet=true;this.displayRightScroller()},SuggestionEngineView.prototype.displayRightScroller=function(h,e){if(!this._rightScrollerPropsSet){this.setUpRightScrollerProps();return}console.log("Displaying Right controller");var g=0;window.gameObj._shrinkAmount=this.imageWidth()+this.imgPadding*3+3;window.gameObj.shrinkCanvas("Width");window.gameObj._shrinkCallBack=this.shrinkFinished.bind(this);var f=this.imgPadding;var a=parseInt(HUDCanvas.clientWidth)-this.imageWidth()-this.imgPadding;if(h){a=h}if(e){f=e}var c=new UIObject();c._name="SuggestionEngineRightBG";c.draw=function(){c._x=GAMECanvas.clientWidth+this.imgPadding-2;c._y=0;HUDctx.strokeStyle="#FFFFFF";HUDctx.fillStyle="rgba(0,0,0,.85)";HUDctx.fillRect(c._x,c._y,this.bgWidth(),this.bgHeight());HUDctx.strokeRect(c._x,c._y,this.bgWidth(),this.bgHeight());HUDctx.fill();HUDctx.stroke()}.bind(this);this.screenElements.push(c);var b=new UIImage();b._name="closeBTN";b._x=parseInt(GAMECanvas.style.left.split("."));b._y=parseInt(GAMECanvas.style.top.split("."));b._width=HUDCanvas.width-this.bgWidth()-4;b._height=GAMECanvas.height;b.draw=function(){console.log("Drawing closebtn");HUDctx.fillStyle="rgba(0,0,0,.75)";this._x=0,this._y=0;this._width=HUDCanvas.width+(c._x-HUDCanvas.width)-2;this._height=HUDCanvas.height;HUDctx.fillRect(0,0,this._width,this._height);HUDctx.fill()};var i=new UIObject();i._name="CloseText";i._caption="Click/Tap Here To Continue";i._recommendText="Play One of These Other Games";i._x=c._x+5;i._y=GAMECanvas.clientHeight/2-HUDctx.measureText(i._caption).height+5;i.draw=function(){HUDctx.fillStyle=("#FFFFFF");HUDctx.font="bold 17px Arial";var j=0.8;var m=b._width*j;var k=m/HUDctx.measureText(i._caption).width;if(k>2){k=2}HUDctx.scale(k,k);i._x=((HUDCanvas.width/2)/k)-HUDctx.measureText(i._recommendText).width/2-(((HUDCanvas.width-c._x)/2)/k);i._y=(HUDCanvas.height/2)/k-(40/k);HUDctx.fillText(i._recommendText,i._x,i._y);i._x=((HUDCanvas.width/2)/k)-HUDctx.measureText("or").width/2-(((HUDCanvas.width-c._x)/2)/k);i._y+=(30/k);HUDctx.fillText("or",i._x,i._y);i._x=((HUDCanvas.width/2)/k)-HUDctx.measureText(i._caption).width/2-(((HUDCanvas.width-c._x)/2)/k);i._y+=(30/k);HUDctx.fillText(i._caption,i._x,i._y);var l=1/k;HUDctx.scale(l,l)}.bind(this);b.callBack=function(){window.gameObj.animatedClose();console.log("closeBTN callback")};while(g<this.imgMax){UIImg=new UIImage();UIImg.props=this._recoms[g].url;UIImg._imgPadding=this.imgPadding;UIImg.imageHeight=this.imageHeight.bind(this);UIImg.imageWidth=this.imageWidth.bind(this);UIImg.gotoURL=this.gotoURL;var d=this._recoms[g].primary_image_url.split("&width=")[0]+"&width="+Math.ceil(this.imageWidth());UIImg.Loader(d,this.imageLoaded.bind(this));UIImg.callBack=function(){this.gotoURL(this.props)};UIImg.draw=function(){this._width=this.imageWidth();this._height=this.imageHeight();this._x=c._x+this._imgPadding;this._y=(this.imageHeight()*this._position)+(this._imgPadding*(this._position+1));HUDctx.drawImage(this._img,this._x,this._y,this._width,this._height)};UIImg._name="SuggestionRightScrollerImage"+g;UIImg._position=g;g++;this._imagesNeedingLoaded.push(UIImg);this.screenElements.push(UIImg);this.buttons.push(UIImg)}this.screenElements.push(b);this.screenElements.push(i);this.buttons.push(b);this.controller.isActive=true;this._imagesLoadedInt=setInterval(this.loading.bind(this),250)},SuggestionEngineView.prototype.loading=function(a){if(this._imagesNeedingLoaded.length==0){clearInterval(this._imagesLoadedInt);console.log("Images are all loaded")}else{window.DisplayList.draw()}},SuggestionEngineView.prototype.displayGrid=function(d){this._animationStatus=SuggestionEngineView.FINISHED_ANIMATION;this._left=(window.gameObj.getCanvas().width-this.bgWidth)/2;this._recoms=this.controller._model.suggestions;var f=new UIObject();f._name="SuggestionEngineBG";f._x=this._left;f._y=this._top;f.draw=function(){HUDctx.strokeStyle="#FFFFFF";HUDctx.fillStyle="rgba(0,0,0,0.9)";HUDctx.fillRect(this._left,this._top,this.bgWidth,this.bgHeight);HUDctx.strokeRect(this._left,this._top,this.bgWidth,this.bgHeight);HUDctx.fill();HUDctx.stroke()}.bind(this);var c=new UIObject();c._name="closeBTN";c._x=this.bgWidth+this._left;c._y=this._top;c.bgWidth=this.bgWidth;c._width=10;c._height=10;c._padding=6;c.draw=function(){HUDctx.fillStyle="rgba(180,180,180,1)";HUDctx.arc(this._x,this._y,10,0,2*Math.PI,false);HUDctx.moveTo(this._x-(this._width-this._padding),this._y-(this._height-this._padding));HUDctx.lineTo(this._x+(this._width-this._padding),this._y+(this._height-this._padding));HUDctx.moveTo(this._x+(this._width-this._padding),this._y-(this._height-this._padding));HUDctx.lineTo(this._x-(this._width-this._padding),this._y+(this._height-this._padding));HUDctx.lineWidth=2;HUDctx.fill();HUDctx.strokeStyle="#FFFFFF";HUDctx.stroke();HUDctx.closePath()};var b=0,j=0,g=0,h=30,k=this._left+(this.bgWidth-(this.colMax*this.imgWidth))/2,e;if(this._recoms.length>0){while(j<2){b=0;while(b<this.colMax){UIImg=new UIImage();console.log("Setting up url");console.log(this._recoms[g].url);UIImg._x=k+parseInt((b*this.imgWidth)+(this.imagePadding*b)),UIImg._y=h+parseInt(this._top);UIImg.props=this._recoms[g].url;UIImg.parent=this;UIImg.callBack=function(){console.log("Got Callback with props ["+this.props+"] this ["+this._name+"]");this.parent.gotoURL(this.props)};UIImg._width=this.imgWidth;UIImg._height=this.imgHeight;var i=this._recoms[g].primary_image_url.split("&width=")[0]+"&width="+this.imgWidth;UIImg._name="SuggestionGridImage"+g;UIImg.Loader(i,this.imageLoaded.bind(this));UIImg.callBack=function(){this.parent.gotoURL(this.props)};this.screenElements.push(UIImg);this.buttons.push(UIImg);b++;g++}j++;h+=this.imgHeight+this.imagePadding}}var a=new UIObject();a._name="Recommendation Text";a.text="Other games we recommend";a._x=f._x+HUDctx.measureText(a.text).width/2;a._y=this._top+80+this.imgHeight*2+this.imagePadding;a.draw=function(){HUDctx.fillStyle=("#FFFFFF");HUDctx.font="bold 20px Arial";this._x=HUDCanvas.clientWidth/2-HUDctx.measureText(a.text).width/2;HUDctx.fillText(this.text,this._x,this._y)};this.screenElements.push(f);this.screenElements.push(a);this.screenElements.push(c);this.buttons.push(c)},SuggestionEngineView.prototype.gotoURL=function(a){window.trackGameEvent({action:"recommendation_"+this._version,action_detail:a.split("/")[a.split("/").length-1]});window.top.location.href=a};